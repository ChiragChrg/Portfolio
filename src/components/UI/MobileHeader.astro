---
import { Download } from "lucide-preact";
import ThemeButton from "@/components/UI/ThemeButton.astro";
import ThemeDropdown from "@/components/UI/ThemeDropdown.astro";

const { config } = Astro.props;

const showThemeDropdown = import.meta.env.PUBLIC_SHOW_THEME_MENU === "true";
---

<header
    class="lg:hidden w-full sticky top-0 z-50 headerGradient backdrop-blur-[2px]"
>
    <div class="flex justify-between items-center py-2 px-4 z-10">
        <a href="#home" class="Fade_In font-satisfy font-bold text-[2em]">
            <span class="gradientText w-fit">{config.logotext}</span>
        </a>

        <div class="flex items-center gap-4">
            {
                showThemeDropdown && (
                    <ThemeDropdown className="Fade_In" idPrefix="Mobile" />
                )
            }

            <ThemeButton className="Fade_In" />

            <button id="Ham_Menu" aria-label="Toggle Menu">
                <svg
                    viewBox="20 20 60 60"
                    width="45"
                    class="Fade_In MobileNav_Ham flex justify-center items-end flex-col gap-2 z-80 cursor-pointer"
                >
                    <path
                        class="line top"
                        d="m 30,33 h 40 c 3.722839,0 7.5,3.126468 7.5,8.578427 0,5.451959 -2.727029,8.421573 -7.5,8.421573 h -20"
                    ></path>
                    <path class="line middle" d="m 30,50 h 40"></path>
                    <path
                        class="line bottom"
                        d="m 70,67 h -40 c 0,0 -7.5,-0.802118 -7.5,-8.365747 0,-7.563629 7.5,-8.634253 7.5,-8.634253 h 20"
                    ></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Backdrop Overlay -->
    <div class="backdrop-blur-[2px] absolute inset-0 -z-10"></div>

    <nav
        id="mobileHeaderNav"
        class="w-full h-svh flex_center flex-col fixed top-0 right-0 gap-8 z-60 opacity-0 pointer-events-none"
        style="clip-path: circle(0px at calc(100% - 45px) 45px);"
    >
        <!-- Translucent blurry background -->
        <div class="absolute inset-0 bg-background/50 backdrop-blur -z-10">
        </div>

        <div class="MobileHeader_Nav flex_center opacity-0 translate-y-4">
            <a href="#about">About</a>
        </div>

        <div class="MobileHeader_Nav flex_center opacity-0 translate-y-4">
            <a href="#skills">Skills</a>
        </div>

        <div class="MobileHeader_Nav flex_center opacity-0 translate-y-4">
            <a href="#projects">Projects</a>
        </div>

        <div class="MobileHeader_Nav flex_center opacity-0 translate-y-4">
            <a href="#contact">Contact</a>
        </div>

        <div class="MobileHeader_Nav flex_center opacity-0 translate-y-4">
            <a
                class="MobileHeader_ActionBtn flex_center"
                href={config.actionButton.url}
                target="_blank"
            >
                <div class="flex_center gap-4">
                    <p>{config.actionButton.text}</p>
                    <Download />
                </div>
            </a>
        </div>
    </nav>
</header>

<script is:inline type="module">
    const headerElement = document.getElementById("mobileHeaderNav");
    const hamMenuSvg = document.querySelector("#Ham_Menu svg");
    const menuItems = document.querySelectorAll(".MobileHeader_Nav");

    let isMenuOpen = false;

    const sectionsList = {
        "#home": document.getElementById("home"),
        "#about": document.getElementById("about"),
        "#skills": document.getElementById("skills"),
        "#projects": document.getElementById("projects"),
        "#contact": document.getElementById("contact"),
    };

    const headerHeight = headerElement?.offsetHeight || 0;

    // Open Mobile Menu
    function openMenu() {
        if (isMenuOpen || !headerElement || !hamMenuSvg) return;

        isMenuOpen = true;
        hamMenuSvg.classList.add("opened");
        headerElement.style.pointerEvents = "auto";
        document.body.style.overflow = "hidden";

        const hamRect = hamMenuSvg.getBoundingClientRect();
        const vv = window.visualViewport;

        const x = hamRect.left + hamRect.width / 2 + (vv?.offsetLeft || 0);
        const y = hamRect.top + hamRect.height / 2 + (vv?.offsetTop || 0);

        const vw = vv?.width || window.innerWidth;
        const vh = vv?.height || window.innerHeight;

        const endRadius = Math.hypot(Math.max(x, vw - x), Math.max(y, vh - y));

        headerElement.animate(
            {
                clipPath: [
                    `circle(0px at ${x}px ${y}px)`,
                    `circle(${endRadius}px at ${x}px ${y}px)`,
                ],
                opacity: [0, 1],
            },
            { duration: 800, easing: "ease-in-out", fill: "forwards" },
        );

        menuItems.forEach((item, i) => {
            item.animate(
                {
                    opacity: [0, 1],
                    transform: ["translateY(40px)", "translateY(0)"],
                },
                {
                    duration: 400,
                    easing: "ease-out",
                    fill: "forwards",
                    delay: 200 + i * 80,
                },
            );
        });
    }

    // Close Mobile Menu
    function closeMenu() {
        if (!isMenuOpen || !headerElement || !hamMenuSvg) return;

        isMenuOpen = false;
        hamMenuSvg.classList.remove("opened");
        document.body.style.overflow = "";

        const hamRect = hamMenuSvg.getBoundingClientRect();
        const vv = window.visualViewport;

        const x = hamRect.left + hamRect.width / 2 + (vv?.offsetLeft || 0);
        const y = hamRect.top + hamRect.height / 2 + (vv?.offsetTop || 0);

        const vw = vv?.width || window.innerWidth;
        const vh = vv?.height || window.innerHeight;

        const endRadius = Math.hypot(Math.max(x, vw - x), Math.max(y, vh - y));

        menuItems.forEach((item, i) => {
            item.animate(
                {
                    opacity: [1, 0],
                    transform: ["translateY(0)", "translateY(-20px)"],
                },
                {
                    duration: 250,
                    easing: "ease-in",
                    fill: "forwards",
                    delay: (menuItems.length - i - 1) * 40,
                },
            );
        });

        headerElement.animate(
            {
                clipPath: [
                    `circle(${endRadius}px at ${x}px ${y}px)`,
                    `circle(0px at ${x}px ${y}px)`,
                ],
                opacity: [1, 0],
            },
            { duration: 700, easing: "ease-in-out", fill: "forwards" },
        ).onfinish = () => {
            headerElement.style.pointerEvents = "none";
            headerElement.style.opacity = "0";
            headerElement.style.clipPath =
                "circle(0px at calc(100% - 45px) 45px)";
        };
    }

    // Add event listeners
    // Only toggle menu when clicking directly on the hamburger menu, not the logo link
    hamMenuSvg.addEventListener("click", (e) => {
        // Only respond to clicks that actually hit the SVG
        if (e.currentTarget !== e.target && !e.target.closest("#Ham_Menu")) {
            return;
        }

        e.stopPropagation();

        if (isMenuOpen) {
            closeMenu();
        } else {
            openMenu();
        }
    });

    // Close menu when clicking on a link
    function closeMenuOnLinkClick(e) {
        e.preventDefault();

        const link = e.currentTarget;
        const href = link.getAttribute("href");
        if (!href) return;

        closeMenu();

        setTimeout(() => {
            document
                .querySelector(href)
                ?.scrollIntoView({ behavior: "smooth" });
        }, 750);
    }

    // Close menu when clicking on navigation links
    document.querySelectorAll("#mobileHeaderNav a").forEach((link) => {
        link.addEventListener("click", closeMenuOnLinkClick);
    });

    // Set Active class on section scroll
    const handleScroll = () => {
        for (const [linkHref, section] of Object.entries(sectionsList)) {
            if (!section) return;

            const rect = section.getBoundingClientRect();
            const link = document.querySelector(
                `#mobileHeaderNav a[href="${linkHref}"]`,
            );

            if (
                link &&
                headerElement &&
                rect.top <= headerHeight &&
                rect.bottom >= headerHeight
            ) {
                link?.classList.add("active");
            } else {
                link?.classList.remove("active");
            }
        }
    };

    // Throttle function to limit scroll event calls
    function throttle(func, limit) {
        let throttling = false;
        return function (...args) {
            if (!throttling) {
                func.apply(this, args);
                throttling = true;
                setTimeout(() => {
                    throttling = false;
                }, limit);
            }
        };
    }

    window.addEventListener("scroll", throttle(handleScroll, 16));
    handleScroll();
</script>
